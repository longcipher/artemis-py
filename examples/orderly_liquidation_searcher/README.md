# Orderly Liquidation Searcher

This is an example liquidation searcher for Orderly Network built with the Artemis-PY framework. It demonstrates how to build a complete trading bot that can monitor liquidation opportunities in real-time and automatically execute liquidation operations.

## Project Overview

Orderly Network's liquidation TPS scales with the number of liquidators, so we implement this open-source liquidation bot to make it easier for more traders to join the liquidation party.

**⚠️ WARNING: This bot is not fully tested! Use at your own risk! It's recommended to test with small amounts first!**

## Architecture Design

### Component Architecture

```
┌─────────────────┐    Events     ┌──────────────────┐    Actions    ┌─────────────────┐
│   Collectors    │──────────────→│    Strategies    │──────────────→│   Executors     │
├─────────────────┤               ├──────────────────┤               ├─────────────────┤
│ REST Collector  │               │ Hedge Strategy   │               │ Orderly         │
│ WebSocket       │               │                  │               │ Executor        │
│ Collector       │               │ - Monitor Events │               │ - Execute Claims│
└─────────────────┘               │ - Calculate P&L  │               │ - Hedge Trades  │
                                  │ - Generate Acts  │               └─────────────────┘
                                  └──────────────────┘
```

### Data Flow

1. **Data Collection**: Collect liquidation events from Orderly's REST API and WebSocket
2. **Strategy Analysis**: Analyze profitability and risk of liquidation opportunities
3. **Execution**: Execute liquidation claims and hedge trades

## Core Components

### 1. Collectors (Data Collectors)

#### OrderlyLiquidationRestCollector

- **Function**: Periodically fetch liquidation list via REST API
- **Data Source**: `GET /v1/liquidation`
- **Update Frequency**: Poll every 2 seconds
- **Deduplication**: Use `liquidation_id` to avoid duplicate processing

#### OrderlyLiquidationWsCollector

- **Function**: Receive liquidation events in real-time via WebSocket
- **Data Source**: WebSocket `/ws/stream/` liquidation channel
- **Real-time**: Millisecond-level latency
- **Connection Management**: Auto-reconnect and error handling

### 2. Strategy (Trading Strategy)

#### OrderlyHedgeStrategy

- **Core Logic**: Identify and process profitable liquidation opportunities
- **Risk Management**:
  - Maximum notional amount limits
  - Whitelist symbol filtering
  - Position size calculation
- **Decision Flow**:
  1. Receive liquidation events
  2. Verify if trading pairs are in whitelist
  3. Calculate potential profit
  4. Generate liquidation claim actions

### 3. Executor (Executor)

#### OrderlyExecutor

- **Main Functions**:
  - Execute liquidation claim operations
  - Automatically hedge position risks
  - Manage order lifecycle

- **Execution Flow**:
  1. Receive actions generated by strategy
  2. Calculate optimal claim quantity and ratio
  3. Call Orderly API to claim liquidation
  4. Wait for liquidation transfer completion
  5. Query current positions
  6. Create hedge orders to close positions

## Configuration

### 1. Application Configuration File

Create a configuration file (e.g., `conf/staging.yml`):

```yaml
app:
  level: "INFO"                    # Log level: DEBUG, INFO, WARNING, ERROR
  port: 8088                       # Health check port

orderly:
  account_id: "your_account_id"    # Your Orderly account ID
  rest_endpoint: "https://testnet-api-evm.orderly.org"           # REST API endpoint
  ws_public_endpoint: "wss://testnet-ws-evm.orderly.network/ws/stream/"  # WebSocket endpoint
  max_notional: 1000               # Maximum notional amount per liquidation (including leverage)
  liquidation_symbols:             # Whitelist trading pairs for liquidation
    - "PERP_BTC_USDC"
    - "PERP_ETH_USDC"
    - "PERP_NEAR_USDC"
    - "PERP_WOO_USDC"
```

### 2. Environment Variables

Create a `.env` file or set environment variables:

```bash
# Orderly API authentication
export ORDERLY_KEY="your_orderly_api_key"
export ORDERLY_SECRET="your_orderly_api_secret"
```

### 3. Network Environment Configuration

- **Testnet**: Use `testnet-*` endpoints for testing
- **Mainnet**: Use `api-evm.orderly.org` and other mainnet endpoints
- **VPN Requirements**: Some environments may require VPN access

## Installation and Running

### 1. Environment Setup

```bash
# Python version requirement: >= 3.10
python --version

# Install uv (if not already installed)
pip install uv

# Activate virtual environment
cd artemis-py
source .venv/bin/activate

# Install example dependencies
uv pip install -e ".[examples]"
```

### 2. Configuration Setup

```bash
# Copy example configuration file
cp conf/staging.yml conf/my_config.yml

# Edit configuration file
vim conf/my_config.yml

# Set API keys
export ORDERLY_KEY="your_key_here"
export ORDERLY_SECRET="your_secret_here"
```

### 3. Run the Bot

```bash
# Switch to example directory
cd examples/orderly_liquidation_searcher

# Run liquidation searcher
python main.py -c ../../conf/my_config.yml
```

### 4. Health Check

After the bot starts, it will provide a health check interface on the configured port:

```bash
# Check bot status
curl http://localhost:8088/health

# Example response
{"status": "ok"}
```

## Monitoring and Logging

### Log Levels

- **DEBUG**: Detailed debugging information, including every event and action
- **INFO**: Regular operation information, including startup, liquidation detection, etc.
- **WARNING**: Important business events, such as executing liquidations, error recovery, etc.
- **ERROR**: Errors and exception situations

### Key Log Examples

```
# Startup information
2025-08-08 06:12:45 | INFO | Starting Artemis Engine...
2025-08-08 06:12:45 | INFO | Starting 2 collectors...
2025-08-08 06:12:45 | INFO | Starting 1 strategies...
2025-08-08 06:12:45 | INFO | Starting 1 executors...

# Liquidation detection
2025-08-08 06:12:46 | INFO | Liquidation detected: PERP_BTC_USDC
2025-08-08 06:12:46 | WARNING | Executing liquidation claim for $1000

# Hedge operations
2025-08-08 06:12:47 | INFO | Creating hedge order: SELL 0.02 BTC
2025-08-08 06:12:47 | INFO | Hedge order executed successfully
```

## Deployment Options

### 1. Systemd Service

```bash
# Copy service file
sudo cp ../../deployment/liquidation_searcher_dev.service /etc/systemd/system/

# Edit service configuration
sudo vim /etc/systemd/system/liquidation_searcher_dev.service

# Start service
sudo systemctl daemon-reload
sudo systemctl enable liquidation_searcher_dev
sudo systemctl start liquidation_searcher_dev

# Check status
sudo systemctl status liquidation_searcher_dev
```

### 2. Docker Container

```bash
# Build image
docker build -t artemis-liquidation-searcher .

# Run container
docker run -d \
  --name liquidation-searcher \
  -e ORDERLY_KEY="your_key" \
  -e ORDERLY_SECRET="your_secret" \
  -p 8088:8088 \
  artemis-liquidation-searcher
```

### 3. Kubernetes Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: liquidation-searcher
spec:
  replicas: 1
  selector:
    matchLabels:
      app: liquidation-searcher
  template:
    metadata:
      labels:
        app: liquidation-searcher
    spec:
      containers:
      - name: liquidation-searcher
        image: artemis-liquidation-searcher:latest
        ports:
        - containerPort: 8088
        env:
        - name: ORDERLY_KEY
          valueFrom:
            secretKeyRef:
              name: orderly-secret
              key: api-key
        - name: ORDERLY_SECRET
          valueFrom:
            secretKeyRef:
              name: orderly-secret
              key: api-secret
        livenessProbe:
          httpGet:
            path: /health
            port: 8088
          initialDelaySeconds: 30
          periodSeconds: 10
```

## Risk Management

### 1. Capital Management

- **Maximum Notional Amount**: Limit single liquidation size through `max_notional`
- **Whitelist Mechanism**: Only operate on configured trading pairs to avoid unknown risks
- **Position Monitoring**: Real-time position monitoring with timely hedging

### 2. Technical Risks

- **API Limits**: Comply with Orderly API rate limits
- **Network Latency**: Consider network latency impact on liquidation timing
- **Exception Handling**: Comprehensive error handling and retry mechanisms

### 3. Monitoring and Alerts

- **Health Checks**: Regularly check service status
- **Log Monitoring**: Monitor error and exception logs
- **Performance Metrics**: Track liquidation success rates, profitability, etc.

## Performance Tuning

### 1. Queue Size Configuration

```python
# Adjust queue capacity in main.py
engine = Engine(
    event_channel_capacity=1024,    # Event queue size
    action_channel_capacity=512     # Action queue size
)
```

### 2. Network Optimization

- Choose the nearest API endpoint to reduce latency
- Use stable network connections
- Consider using multiple WebSocket connections for better reliability

### 3. Strategy Optimization

- Adjust detection thresholds based on market conditions
- Optimize liquidation claim quantity calculation logic
- Implement smarter hedging strategies

## Troubleshooting

### Common Issues

1. **API Authentication Failed**
   - Check if `ORDERLY_KEY` and `ORDERLY_SECRET` are correct
   - Verify API keys have sufficient permissions

2. **WebSocket Connection Failed**
   - Check network connection and firewall settings
   - Try switching network environment or using VPN

3. **Liquidation Claim Failed**
   - Check if account balance is sufficient
   - Verify trading pairs are in whitelist
   - Check API error messages

4. **Hedge Order Failed**
   - Check position information is correct
   - Verify order size meets minimum trading requirements
   - Validate order price and market conditions

### Debugging Tips

1. **Enable DEBUG logging**:
   ```yaml
   app:
     level: "DEBUG"
   ```

2. **Test components individually**:
   ```python
   # Test REST collector
   collector = OrderlyLiquidationRestCollector(account_id, endpoint)
   collector.start()
   event = await collector.get_event_stream()
   print(event)
   ```

3. **Use testnet environment**: Validate all functionality on testnet before mainnet deployment

## 扩展开发

### 1. 添加新的收集器

```python
class CustomCollector(Collector):
    def start(self, timeout=None):
        # 实现数据收集逻辑
        pass
    
    async def get_event_stream(self):
        # 返回自定义事件格式
        return {"event_type": "custom_event", "data": "..."}
```

### 2. 实现新的策略

```python
class CustomStrategy(Strategy):
    async def sync_state(self):
        # 初始化策略状态
        pass
    
    async def process_event(self, event):
        # 实现自定义交易逻辑
        if self.should_trade(event):
            return {"action_type": "custom_action", "data": "..."}
        return None
```

### 3. 添加新的执行器

```python
class CustomExecutor(Executor):
    async def sync_state(self):
        # 初始化执行器
        pass
    
    async def execute(self, action):
        # 执行自定义动作
        if action["action_type"] == "custom_action":
            await self.handle_custom_action(action)
```

## 贡献指南

欢迎贡献代码和改进建议！请参考以下流程：

1. Fork 项目仓库
2. 创建功能分支：`git checkout -b feature/new-feature`
3. 提交更改：`git commit -m 'Add new feature'`
4. 推送分支：`git push origin feature/new-feature`
5. 创建 Pull Request

## 免责声明

本软件按"现状"提供，不提供任何形式的保证。加密货币交易涉及重大风险，可能导致重大财务损失。用户有责任做出自己的交易决定，在部署真实资金之前应彻底测试任何策略。

## 许可证

本项目基于 MIT 许可证开源 - 详情请参见 LICENSE 文件。
